<!DOCTYPE html>
<html>

<head>
  <title>Invoice Generator</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body {
      padding: 20px;
    }

    #generateInvoiceContainer {
      max-width: 400px;
      margin: 0 auto;
    }

    #generateInvoiceBtn {
      margin-top: 20px;
    }
  </style>
</head>

<body>
  
  <div id="generateInvoiceContainer">
    <h1 class="text-center">Invoice Generator</h1>
    <div class="mb-3">
      <label for="costInput" class="form-label">Cost:</label>
      <input type="number" class="form-control" id="costInput" placeholder="Enter cost">
    </div>

    <div class="mb-3">
      <label for="issueDateInput" class="form-label">Issue Date:</label>
      <input type="date" class="form-control" id="issueDateInput" placeholder="Select issue date">
    </div>

    <button id="generateInvoiceBtn" class="btn btn-primary">Generate Invoice</button>
  </div>

  <script>


    $(document).ready(function () {


      function viewFileAsPDF(fileId, accessToken) {
        // Set the endpoint URL
        const endpoint = `https://www.googleapis.com/drive/v3/files/${fileId}/export?mimeType=application/pdf`;

        // Make the AJAX request
        $.ajax({
          type: 'GET',
          url: endpoint,
          headers: {
            'Authorization': 'Bearer ' + accessToken,
          },
          xhrFields: {
            responseType: 'blob' // Set the response type to 'blob'
          },
          success: function (data) {
            // Create a Blob from the response data
            const blob = new Blob([data], { type: 'application/pdf' });

            // Create a URL for the Blob
            const url = URL.createObjectURL(blob);

            // Open the PDF in a new window
            window.open(url, '_blank');
          },
          error: function (error) {
            console.error('Error:', error);
            // Handle error response
          }
        });
      }



      // Retrieve the access token from session storage
      const accessToken = sessionStorage.getItem('access_token');
      if (!accessToken) {
        window.location.href = 'login.html'
      } else {
        document.getElementById('generateInvoiceBtn').addEventListener('click', function () {
          // Get the input values
          let cost = document.getElementById('costInput').value;
          let issueDate = document.getElementById('issueDateInput').value;
          cost = parseFloat(cost)
          if (isNaN(cost) || cost <= 0) {
            alert('Must be postive number')
            return
          }
          cost = cost.toFixed(2)
          issueDate = issueDate ? issueDate : new Date()

          // Call the cloud function
          fetch('https://us-central1-tokyo-portal-389614.cloudfunctions.net/generatePDF', {
            method: 'POST',
            headers: {
              'Authorization': 'Bearer ' + accessToken,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ cost: cost, issueDate: issueDate }),
          })
            .then(response => response.json())
            .then(data => {
              console.log(data);
              viewFileAsPDF(data.documentId, accessToken)
            })
            .catch(error => {
              console.log(error)
              sessionStorage.removeItem('access_token');
              window.location.href = 'login.html';
            });
        });

      }
    })


  </script>
</body>

</html>